# MongoDB Atlas GCP Terraform Module

Integrates MongoDB Atlas with Google Cloud Platform:

- **Encryption at Rest** using Google Cloud KMS (customer-managed keys)
- **PrivateLink** via Private Service Connect (PSC) with port-mapped architecture
- **Backup Export** to Google Cloud Storage (GCS)

## Usage

```hcl
module "atlas_gcp" {
  source     = "terraform-mongodbatlas-modules/atlas-gcp/mongodbatlas"
  project_id = "64259ee860c43338194b0f8e"

  encryption = {
    enabled                 = true
    key_version_resource_id = google_kms_crypto_key_version.atlas.id
  }
}
```

<!-- BEGIN_TF_DOCS -->
<!-- @generated
WARNING: This section is auto-generated by terraform-docs. Do not edit directly.
Changes will be overwritten when documentation is regenerated.
Run 'just docs' to regenerate.
-->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9)

- <a name="requirement_google"></a> [google](#requirement\_google) (>= 6.0)

- <a name="requirement_mongodbatlas"></a> [mongodbatlas](#requirement\_mongodbatlas) (~> 2.6)

## Providers

The following providers are used by this module:

- <a name="provider_mongodbatlas"></a> [mongodbatlas](#provider\_mongodbatlas) (~> 2.6)

- <a name="provider_terraform"></a> [terraform](#provider\_terraform)

## Resources

The following resources are used by this module:

- [mongodbatlas_private_endpoint_regional_mode.this](https://registry.terraform.io/providers/mongodb/mongodbatlas/latest/docs/resources/private_endpoint_regional_mode) (resource)
- [mongodbatlas_privatelink_endpoint.this](https://registry.terraform.io/providers/mongodb/mongodbatlas/latest/docs/resources/privatelink_endpoint) (resource)
- [terraform_data.region_validations](https://registry.terraform.io/providers/hashicorp/terraform/latest/docs/resources/data) (resource)

<!-- BEGIN_TF_INPUTS_RAW -->
<!-- @generated
WARNING: This grouped inputs section is auto-generated. Do not edit directly.
Changes will be overwritten when documentation is regenerated.
Run 'just docs' to regenerate.
-->
## Required Variables

### project_id

MongoDB Atlas project ID

Type: `string`


## GCP Cloud Provider Access

Configure the GCP service account used by MongoDB Atlas. See the [GCP cloud provider access documentation](https://www.mongodb.com/docs/atlas/security/set-up-unified-gcp-access/) for details.

### cloud_provider_access

Cloud provider access configuration for Atlas-GCP integration.
- `create = true` (default): Creates a shared Atlas service account and authorization
- `create = false`: Use existing CPA via `existing.role_id` and `existing.service_account_for_atlas`

Type:

```hcl
object({
  create = optional(bool, true)
  existing = optional(object({
    role_id                   = string
    service_account_for_atlas = string
  }))
})
```

Default: `{}`


## Encryption at Rest

Configure encryption at rest using Google Cloud KMS. See the [GCP encryption documentation](https://www.mongodb.com/docs/atlas/security-gcp-kms/) for details.

### encryption

Encryption at rest configuration with Google Cloud KMS.

Provide EITHER:
- `key_version_resource_id` (user-provided KMS key version)
- `create_kms_key.enabled = true` (module-managed Key Ring + Crypto Key)

`key_ring_name` sets the name for the GCP KMS key ring. When omitted, defaults to
`atlas-{project_id}-keyring` to avoid collisions across Atlas projects sharing the
same GCP project and location. Key rings are permanent in GCP -- choose stable names.
GCP allows 1-63 characters (`[a-zA-Z][a-zA-Z0-9_-]*`); the auto-generated name is
38 characters (well within the limit).

`crypto_key_name` sets the name for the GCP KMS crypto key within the key ring.
When omitted, defaults to `atlas-encryption-key`. No project ID prefix needed since
the key is already scoped within the key ring.

`location` accepts GCP locations (`us-east4`) or Atlas region names (`US_EAST_4`).
Multi-regional locations (`us`, `europe`, `asia`) are also valid.

`rotation_period` controls GCP automatic key version rotation.
Format: seconds as string, e.g., "7776000s" (90 days). Should be > 86400s (1 day).
When omitted, no automatic rotation occurs. Atlas recommends 90-day rotation and
creates an alert at that cadence. Each rotation causes a plan diff on
key_version_resource_id on the next terraform apply. Old key versions remain
enabled -- no data re-encryption is needed.

`dedicated_role_enabled = true` creates a dedicated Atlas service account for encryption.

Type:

```hcl
object({
  enabled                 = optional(bool, false)
  key_version_resource_id = optional(string)
  create_kms_key = optional(object({
    enabled         = optional(bool, false)
    key_ring_name   = optional(string)
    crypto_key_name = optional(string)
    location        = optional(string, "")
    rotation_period = optional(string)
  }), {})
  dedicated_role_enabled = optional(bool, false)
})
```

Default: `{}`


## Private Service Connect

Configure GCP Private Service Connect (PSC) endpoints for secure connectivity. See the [GCP PrivateLink documentation](https://www.mongodb.com/docs/atlas/security-private-endpoint/) for details.

### privatelink_endpoints

Multi-region PrivateLink endpoints via PSC. Region accepts us-east4 or US_EAST_4 format. All regions must be UNIQUE.

Type:

```hcl
list(object({
  region     = string
  subnetwork = string
  labels     = optional(map(string), {})
}))
```

Default: `[]`

### privatelink_endpoints_single_region

Single-region multi-endpoint pattern. All regions must MATCH.
Use when multiple VPCs in the same region need PSC connectivity to Atlas.

Type:

```hcl
list(object({
  region     = string
  subnetwork = string
  labels     = optional(map(string), {})
}))
```

Default: `[]`

### privatelink_byoe_regions

BYOE Phase 1: Key is user identifier, value is GCP region (us-east4 or US_EAST_4).

Type: `map(string)`

Default: `{}`

### privatelink_byoe

BYOE Phase 2: Forwarding rule details. Key must exist in privatelink_byoe_regions.

Type:

```hcl
map(object({
  ip_address           = string
  forwarding_rule_name = string
}))
```

Default: `{}`


## Backup Export

Configure backup snapshot export to Google Cloud Storage (GCS).

### backup_export

Backup snapshot export to GCS configuration.

Provide EITHER:
- `bucket_name` (user-provided GCS bucket)
- `create_bucket.enabled = true` (module-managed GCS bucket)

**Bucket Naming:**
- `name` accepts a string to set an explicit bucket name (must be globally unique in GCS). When omitted, the bucket name is auto-generated as `atlas-backup-{project_id}`.
- `name_suffix` accepts a string appended to the auto-generated name, resulting in `atlas-backup-{project_id}{name_suffix}`. Include a separator (e.g. `"-dev"` produces `atlas-backup-{project_id}-dev`). Mutually exclusive with `name`.

**Location:**
`location` accepts GCP regions (`us-east4`), Atlas format (`US_EAST_4`),
multi-regions (`US`, `EU`, `ASIA`), or dual-regions (`NAM4`, `EUR4`).
Atlas format is normalized via `atlas_to_gcp_region`. Choose a region
colocated with the Atlas cluster for lowest latency.

**Security:**
- `uniform_bucket_level_access` accepts `true` or `false` to control IAM-only access (no per-object ACLs). Defaults to `true`.
- `public_access_prevention` accepts `"enforced"` to block public access or `"inherited"` to use project-level settings. Defaults to `"enforced"`.
- `versioning_enabled` accepts `true` or `false` to enable or disable object versioning for backup recovery. Defaults to `true`.

`dedicated_role_enabled = true` creates a dedicated Atlas service account for backup export.

Type:

```hcl
object({
  enabled     = optional(bool, false)
  bucket_name = optional(string)
  create_bucket = optional(object({
    enabled                     = optional(bool, false)
    name                        = optional(string, "")
    name_suffix                 = optional(string, "")
    location                    = optional(string, "")
    force_destroy               = optional(bool, false)
    storage_class               = optional(string, "STANDARD")
    versioning_enabled          = optional(bool, true)
    uniform_bucket_level_access = optional(bool, true)
    public_access_prevention    = optional(string, "enforced")
  }), {})
  dedicated_role_enabled = optional(bool, false)
})
```

Default: `{}`


## Regions Mapping

### atlas_to_gcp_region

Atlas to GCP region mapping. Keys = Atlas format, values = GCP format.
The module accepts either format in all region inputs and normalizes internally.
Override to restrict allowed regions or add custom mappings.

Type: `map(string)`

Default:

```json
{
  "AFRICA_SOUTH_1": "africa-south1",
  "ASIA_EAST_2": "asia-east2",
  "ASIA_NORTHEAST_2": "asia-northeast2",
  "ASIA_NORTHEAST_3": "asia-northeast3",
  "ASIA_SOUTHEAST_2": "asia-southeast2",
  "ASIA_SOUTH_1": "asia-south1",
  "ASIA_SOUTH_2": "asia-south2",
  "AUSTRALIA_SOUTHEAST_1": "australia-southeast1",
  "AUSTRALIA_SOUTHEAST_2": "australia-southeast2",
  "CENTRAL_US": "us-central1",
  "EASTERN_ASIA_PACIFIC": "asia-east1",
  "EASTERN_US": "us-east1",
  "EUROPE_CENTRAL_2": "europe-central2",
  "EUROPE_NORTH_1": "europe-north1",
  "EUROPE_SOUTHWEST_1": "europe-southwest1",
  "EUROPE_WEST_10": "europe-west10",
  "EUROPE_WEST_12": "europe-west12",
  "EUROPE_WEST_2": "europe-west2",
  "EUROPE_WEST_3": "europe-west3",
  "EUROPE_WEST_4": "europe-west4",
  "EUROPE_WEST_6": "europe-west6",
  "EUROPE_WEST_8": "europe-west8",
  "EUROPE_WEST_9": "europe-west9",
  "MIDDLE_EAST_CENTRAL_1": "me-central1",
  "MIDDLE_EAST_CENTRAL_2": "me-central2",
  "MIDDLE_EAST_WEST_1": "me-west1",
  "NORTHEASTERN_ASIA_PACIFIC": "asia-northeast1",
  "NORTH_AMERICA_NORTHEAST_1": "northamerica-northeast1",
  "NORTH_AMERICA_NORTHEAST_2": "northamerica-northeast2",
  "NORTH_AMERICA_SOUTH_1": "northamerica-south1",
  "SOUTHEASTERN_ASIA_PACIFIC": "asia-southeast1",
  "SOUTH_AMERICA_EAST_1": "southamerica-east1",
  "SOUTH_AMERICA_WEST_1": "southamerica-west1",
  "US_EAST_4": "us-east4",
  "US_EAST_5": "us-east5",
  "US_SOUTH_1": "us-south1",
  "US_WEST_2": "us-west2",
  "US_WEST_3": "us-west3",
  "US_WEST_4": "us-west4",
  "WESTERN_EUROPE": "europe-west1",
  "WESTERN_US": "us-west1"
}
```


## Optional Variables

### gcp_tags

Labels to apply to all GCP resources created by this module.

Type: `map(string)`

Default: `{}`

<!-- END_TF_INPUTS_RAW -->

## Outputs

The following outputs are exported:

### <a name="output_backup_export"></a> [backup\_export](#output\_backup\_export)

Description: Backup export configuration

### <a name="output_encryption"></a> [encryption](#output\_encryption)

Description: Encryption at rest status and configuration

### <a name="output_encryption_at_rest_provider"></a> [encryption\_at\_rest\_provider](#output\_encryption\_at\_rest\_provider)

Description: Value for cluster's encryption\_at\_rest\_provider attribute

### <a name="output_export_bucket_id"></a> [export\_bucket\_id](#output\_export\_bucket\_id)

Description: Export bucket ID for backup schedule auto\_export\_enabled

### <a name="output_privatelink"></a> [privatelink](#output\_privatelink)

Description: PrivateLink status per endpoint key

### <a name="output_privatelink_service_info"></a> [privatelink\_service\_info](#output\_privatelink\_service\_info)

Description: Atlas PrivateLink service info for BYOE pattern

### <a name="output_regional_mode_enabled"></a> [regional\_mode\_enabled](#output\_regional\_mode\_enabled)

Description: Whether private endpoint regional mode is enabled

### <a name="output_resource_ids"></a> [resource\_ids](#output\_resource\_ids)

Description: All resource IDs for data source lookups

### <a name="output_role_id"></a> [role\_id](#output\_role\_id)

Description: Atlas Cloud Provider Access role ID
<!-- END_TF_DOCS -->

## FAQ

**Why does the module require mongodbatlas provider ~> 2.6?**

Provider >= 2.7.0 (target: Feb 18th) adds `port_mapping_enabled` on `mongodbatlas_privatelink_endpoint`, required for port-mapped PSC architecture. The `~> 2.6` constraint allows this upgrade.

**How does region format work?**

All region variables accept both GCP format (`us-east4`) and Atlas format (`US_EAST_4`). The module normalizes internally using a static 41-entry mapping.

**Why is there no encryption private endpoint support?**

Atlas does not support private endpoints for GCP KMS. Only AWS KMS (via PrivateLink) and Azure Key Vault (via Private Link) are supported.

**What is the difference between `privatelink_endpoints` and `privatelink_endpoints_single_region`?**

`privatelink_endpoints` is for multi-region deployments (unique region per entry, region used as `for_each` key). `privatelink_endpoints_single_region` is for multiple VPCs in the same region (list index as key). They are mutually exclusive.

## License

See [LICENSE](LICENSE) for full details.
